@using Com.HSJF.Framework.DAL
@using Com.HSJF.HEAS.Web.Helper
@model Com.HSJF.HEAS.Web.Models.Audit.BaseAuditViewModel
@helper GetDictionary(string parentPath)
{
    foreach (var t in new Com.HSJF.HEAS.Web.Helper.DictionaryHelper().GetListByTypeAll("", parentPath))
    {
        <option value="@t.Value" data-show="@t.Disabled">@t.Text</option>}
}
@helper GetDictionaryCheckbox(string parentPath)
{
    foreach (var t in new Com.HSJF.HEAS.Web.Helper.DictionaryHelper().GetListByTypeAll("", parentPath))
    {
        <div class="checkbox_rejecttype">
            <label for="@t.Value">
                <input type="checkbox" value="@t.Value" name="RejectType" id="@t.Value" />
                <span>@t.Text</span>
            </label>
        </div>}}
<div id="reject_block" class="hide" dialog-title="拒绝原因">
    <div class="row no-margin no-padding padt10">
        @GetDictionaryCheckbox("-RejectReason")
        <div class="clear"></div>
        <div class="vspace-10"></div>
        <div class="shenpi_title">备注:</div>
        <textarea rows="5" cols="40" width="100%" placeholder="备注" id="Description"></textarea>
        <!--<input type="hidden" data-field="RejectType" data-class="BaseAudit" id="RejectType" />-->
        <input type="hidden" data-field="Description" data-class="BaseAudit" id="BaseAudit_Description" />
    </div>
</div>

<input id="BaseAudit_ID" type="hidden" value="@ViewBag.ID" />

<div class="page-content">
    <div class="page-header">
        <h1>
            <a class="label label-lg label-light arrowed" href="/Audit/AuditIndex/">返回</a>
            &nbsp;
            审核
            <small>
                <i class="icon-double-angle-right"></i>
                详情
            </small>
        </h1>
    </div><!-- /.page-header -->
    <div class="hs-tool-bar">
       	@if (User.IsInRole("2Audit") && Model.CaseStatus == CaseStatus.HatsPending)
	    {
	        <button class="btn btn-xs btn-warning" onclick="RollbackAuditCase();">
	            <i class="icon-rotate-left"></i>
	            退回
	        </button>
	    }
	    <span class="text-primary app_mright">
       		&nbsp;@CaseStatusHelper.GetStatsText(Model.CaseStatus)
       	</span>
       	<span class="app_mright">
       		&nbsp;案件状态:
       	</span>
        <span class="text-danger app_mright">
       		&nbsp;短借
       	</span>
       	<span class="app_mright">
       		&nbsp;案件类型:
       	</span>
       	<span class="text-success app_mright">
       		&nbsp;@Model.CaseNum
       	</span>&nbsp;
    	<span class="app_mright">
       		&nbsp;案件编号:
       	</span>
    </div>

    <div class="vspace-10"></div>

    <div class="row padt10">
        <div class="col-xs-12">
            <div class="tabbable">
                <ul class="nav nav-tabs" id="myTab">
                    <li class="active"><a data-toggle="tab" href="#basic">进件信息</a></li>
                    <li><a data-toggle="tab" href="#researchInfo">调查信息</a></li>
                    <li><a data-toggle="tab" href="#AuditInfo">审核信息</a></li>
                    <li><a data-toggle="tab" href="#history">流程历史</a></li>
                </ul>

                <div class="tab-content">
                    <div id="basic" class="tab-pane active">

                        <div class="vspace-10"></div>

                        <h6 class="header smaller blue">申请信息</h6>
                        <div class="row padt10">
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group hide">
                                <label>ID</label>
                                <input class="form-control" type="text" data-field="ID" data-class="BaseAudit" maxlength="100"/>
                                <input class="form-control" type="hidden" data-field="CaseNum" data-class="BaseAudit" disabled />
                            	<input class="form-control" type="hidden" data-field="BorrowerName" data-class="BaseAudit"/>
                            	<input class="form-control" type="hidden" data-field="CaseStatus" data-class="BaseAudit" disabled />
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>地区</label>
                                <select class="form-control" data-field="DistrictID" data-class="BaseAudit" id="DistrictID" onchange="districtChange(true)" disabled>
                                    <option value=""></option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>分公司</label>
                                <select class="form-control" data-field="SalesGroupID" data-class="BaseAudit" id="SalesGroupID" onchange="salesGroupChange(true)" disabled>
                                    <option value=""></option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>销售人员</label>
                                <select class="form-control" data-field="SalesID" data-class="BaseAudit" id="SalesID" disabled>
                                    <option value=""></option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>申请额度</label>
                                <div class="input-group">
                                    <input class="form-control" type="text" data-field="LoanAmount" data-class="BaseAudit" maxlength="15" onkeyup="formoney(event,this,2)" disabled/>
                                    <span class="input-group-addon">元</span>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>申请期限</label>
                                <select class="form-control" data-fill-code="Dict:-LoanTerm" data-field="Term" data-class="BaseAudit" disabled>
                                    <option></option>
                                    @GetDictionary("-LoanTerm")
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>申请利率（年）</label>
                                <div class="input-group">
                                    <input class="form-control" type="text" data-field="AnnualRate" data-class="BaseAudit" valid-type="float" data-rate="rate" maxlength="8" disabled/>
                                    <span class="input-group-addon">%</span>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>服务费率</label>
                                <div class="input-group">
                                <input class="form-control" type="text" data-field="ServiceChargeRate" data-class="BaseAudit" valid-type="float" data-rate="rate" maxlength="8" disabled/>
                                    <span class="input-group-addon">%</span>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>客户保证金</label>
                                <div class="input-group">
                                    <input class="form-control" type="text" data-field="CustEarnestMoney" data-class="BaseAudit" onkeyup="formoney(event,this,2)" maxlength="15" disabled />
                                    <span class="input-group-addon">元</span>
                                </div>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">
                                <label>还款来源</label>
                                <textarea class="form-control" rows="5" data-field="PaymentFactor" data-class="BaseAudit" maxlength="1000" disabled></textarea>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">
                                <label>借款用途</label>
                                <textarea class="form-control" rows="5" data-field="Purpose" data-class="BaseAudit" maxlength="1000" disabled></textarea>
                            </div>
                        </div>
                        <div class="vspace-10"></div>
                        
						<h6 class="header smaller blue">打款账户</h6>
                        <div class="row padt10">
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>账户名称</label>
                                <input type="hidden" data-field="OpeningSite" data-class="BaseAudit" disabled/>
                            	<select disabled class="form-control" id="OpeningSite" onchange="changeAccount(this);">
                                    <option value=""></option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>开户行</label>
                                <input class="form-control" type="text" data-field="OpeningBank" data-class="BaseAudit" maxlength="100" disabled />
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>银行卡号</label>
                                <input class="form-control" type="text" data-field="BankCard" data-class="BaseAudit" maxlength="100" disabled />
                            </div>
                        </div>
                        
                        <div class="vspace-10"></div>
                     	<h6 class="header smaller blue">
                            关系人
                        </h6>
                        <div class="table-responsive">
                            <table disabled id="basecase_person_list" class="table table-striped table-bordered table-hover" for="dialog_person" data-class="BaseAudit" data-field="RelationPersonAudits" data-child="RelationPersonAudits">
                                <thead>
                                    <tr>
                                        <th>姓名</th>
                                        <th>关系人类型</th>
                                        <th>证件类型</th>
                                        <th>证件号码</th>
                                        <th>婚姻状况</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="vspace-10"></div>
                        
                        <h6 class="header smaller blue">
                            房产信息
                        </h6>
                        <div class="table-responsive">
                            <table disabled id="basecase_facility_list" class="table table-striped table-bordered table-hover" for="dialog_facility" data-class="BaseAudit" data-field="CollateralAudits" data-child="CollateralAudits">
                                <thead>
                                    <tr>
                                        <th>类型</th>
                                        <th>楼盘名称</th>
                                        <th>地址</th>
                                        <th>权利人</th>
                                        <th>面积<span>（单位：米<sup>2</sup>）</span></th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="researchInfo" class="tab-pane">
                       	<h6 class="header smaller blue">
                      		案件信息
                        </h6>
						<div class="row padt10">
							<div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>综合抵押率</label>
                                <div class="input-group">
                                <input class="form-control" type="text" data-field="ComprehensiveRate" data-class="BaseAudit" valid-type="float" data-rate="rate" maxlength="8" disabled/>
                                    <span class="input-group-addon">%</span>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>抵押次数</label>
                                <select class="form-control" data-fill-code="Dict:-FSLoan" data-field="MortgageOrder" data-class="BaseAudit" disabled>
                                    <option></option>
                                    @GetDictionary("-FSLoan")
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12 form-group">
                                <label>外访费（下户费）</label>
                                <div class="input-group">
                                <input class="form-control" type="text" data-field="OutboundCost" data-class="BaseAudit" maxlength="15" onkeyup="formoney(event,this,2)" disabled />
                                    <span class="input-group-addon">元</span>
                                </div>
                            </div>
						</div>

						<div class="vspace-10"></div>
						<h6 class="header smaller blue">
                            被执行人情况
                        </h6>
                        <div class="table-responsive">
                            <table disabled id="audit_EnforcementPersons_list" class="table table-striped table-bordered table-hover" for="dialog_EnforcementPersons" data-class="BaseAudit" data-field="EnforcementPersons" data-child="EnforcementPersons">
                                <thead>
                                    <tr>
                                        <th>姓名</th>
                                        <th>全国被执行网情况</th>
                                        <th>法院开庭记录</th>
                                        <th>Lawxin</th>
                                        <th>失信网失信记录</th>
                                        <th>社会负面新闻</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="vspace-10"></div> 
                        <h6 class="header smaller blue">
                            工商税务情况
                        </h6>
                        <div class="table-responsive">
                            <table disabled id="audit_IndustryCommerceTaxs_list" class="table table-striped table-bordered table-hover" for="dialog_IndustryCommerceTaxs" data-class="BaseAudit" data-field="IndustryCommerceTaxs" data-child="IndustryCommerceTaxs">
                                <thead>
                                    <tr>
                                        <th>企业名称</th>
                                        <th>企业年检情况</th>
                                        <th>公司实际经营</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                	    <div class="vspace-10"></div> 
                    	<h6 class="header smaller blue">
                            房屋明细
                        </h6>
                        <div class="table-responsive">
                            <table disabled id="audit_HouseDetails_list" class="table table-striped table-bordered table-hover" for="dialog_HouseDetails" data-class="BaseAudit" data-field="HouseDetails" data-child="HouseDetails">
                                <thead>
                                    <tr>
                                        <th>房屋名称</th>
                                        <th>评估价<span>（单位：元）</span></th>
                                        <th>房屋类型</th>
                                        <th>抵押情况</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="AuditInfo" class="tab-pane">
                        <h6 class="header smaller blue">
                            个人资信情况
                        </h6>
                        <div class="table-responsive">
                            <table disabled id="audit_IndividualCredits_list" class="table table-striped table-bordered table-hover" for="dialog_IndividualCredits" data-class="BaseAudit" data-field="IndividualCredits" data-child="IndividualCredits">
                                <thead>
                                    <tr>
                                        <th>姓名</th>
                                        <th>信用卡</th>
                                        <th>房贷、车贷</th>
                                        <th>其他贷款</th>
                                        <th>逾期情况</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="vspace-10"></div>
                      	<h6 class="header smaller blue">
                            企业资信情况
                        </h6>
                        <div class="table-responsive">
                            <table disabled id="audit_EnterpriseCredits_list" class="table table-striped table-bordered table-hover" for="dialog_EnterpriseCredits" data-class="BaseAudit" data-field="EnterpriseCredits" data-child="EnterpriseCredits">
                                <thead>
                                    <tr>
                                        <th>企业名称</th>
                                        <th>企业贷款卡</th>
                                        <th>企业负债信息</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="vspace-10"></div>
                        <h6 class="header smaller blue">产品信息</h6>
                        <div class="row padt10">
							<div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
			                    <label>审批金额</label>
			                    <div class="input-group">
			                    <input class="form-control" type="text" data-field="AuditAmount" data-class="BaseAudit" maxlength="15" onkeyup="formoney(event,this,2)" disabled />
                                    <span class="input-group-addon">元</span>
                                </div>
			                </div>
			                <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
			                    <label>审批期限</label>
			                    <select class="form-control" data-fill-code="Dict:-LoanTerm" data-field="AuditTerm" data-class="BaseAudit" disabled>
                                    <option></option>
                                    @GetDictionary("-LoanTerm")
                                </select>
			                </div>    
			                <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
			                    <label>审批利率（年）</label>
			                    <div class="input-group">
			                    <input class="form-control" type="text" data-field="AuditRate" data-class="BaseAudit" valid-type="float" data-rate="rate" maxlength="8" disabled />
                                    <span class="input-group-addon">%</span>
                                </div>
			                </div>    
			                <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
			                    <label>放款日期</label>
			                    <div class="input-group">
			                    <input class="form-control date-picker" type="text" data-field="LendingDate" data-class="BaseAudit"  valid-type="date" disabled/>
                                    <span class="input-group-addon">
                                        <i class="icon-calendar bigger-110"></i>
                                    </span>
                                </div>
			                </div>    
							<div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
			                    <label>借款申请书</label>
			                    <label class="form-control control-label hs-clickable text-center" onclick="fileUploadFunction(this);" disabled>查看附件 &nbsp;<span class="blue">(0)</span></label>
                    			<div class="hide" data-field="LoanProposedFile" data-class="BaseAudit" data-type="files"><ul class="fileupload_list"></ul></div>
			                </div> 
			                <div class="col-lg-4 col-md-6 col-sm-12 col-xs-12 form-group">
			                    <label>放款条件</label>
			                    <select class="form-control" data-fill-code="Dict:-LoanTerm" data-field="LendingTerm" data-class="BaseAudit" disabled>
                                    <option></option>
                                    @GetDictionary("-LendingTerm")
                                </select>
			                </div>    
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">
                                <label>拒绝理由</label>
                                <textarea class="form-control" rows="5" data-field="RejectType" data-class="BaseAudit" maxlength="1000" disabled id="RejectType"></textarea>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">
                                <label>批注意见</label>
                                <textarea class="form-control" rows="5" data-field="AuditComment" data-class="BaseAudit" maxlength="1000" disabled></textarea>
                            </div>
                            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 form-group">
                                <label>签约要件</label>
                                <textarea class="form-control" rows="5" data-field="ContractFileInfo" data-class="BaseAudit" maxlength="1000" disabled></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="history" class="tab-pane">
                        <div class="row padt10">
                            <div id="timeline-1">
                                <div class="row">
                                    <div class="col-xs-12 col-sm-10 col-sm-offset-1">
                                        <div class="timeline-container">
                                            <div class="timeline-items" id="historyContent">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div><!-- /.page-content -->

@Html.Partial("dialog_readonly")
<script type="text/javascript" src="../../js/init.js"></script>
<script type="text/javascript">
    //案件模式
    function caseModel(obj) {
        if ($(obj).val() != "-CaseMode-ZiYouZiJin") {
            $('[data-field="ThirdParty"]').removeAttr("disabled");
        } else {
            $('[data-field="ThirdParty"]').val("").attr("disabled", true);
        }
    }

    //保存
    function EditAuditCase() {
        //$("#shenpiyijian").find('[data-field="LoanDetailReportFile"]').removeAttr("data-field").removeAttr("data-class");
        //$("#shenpiyijian").find('[data-field="CaseDetail"]').removeAttr("data-field").removeAttr("data-class");
        if (ValidateCheckSave(".page-content")) {
            var data_case = GetJsonData("BaseAudit");
            data_case = checkSelectNull(data_case);
            selAccount();
            AjaxMethod("post", "/Audit/EditBaseAudit", data_case, function (r) {
                showAlert("保存成功");
                hideLoading();
                //          window.location = "/Audit/AuditIndex?status=ss";
            }, true);
        }
    }

    //自动保存
    function AutoSave() {
        var isValid = ValidateCheckSave(".page-content");
        var data_case = GetJsonData("BaseAudit");
        data_case = checkSelectNull(data_case);
        selAccount();
        if (isValid) {
            AjaxMethod("post", "/Audit/EditBaseAudit", data_case, function (r) { 
            	showAlert("保存成功"); 
            	hideLoading();
            }, true);
        }
    }
    //删除方法
    function deleteTr() {
        var isValid = ValidateCheckSave(".page-content");
        var data_case = GetJsonData("BaseCase");
        data_case = checkSelectNull(data_case);
        selAccount();
        if (isValid) {
            AjaxMethod("post", "/Audit/EditBaseAudit", data_case, function (r) {
                showAlert("删除成功");
                hideLoading();
            }, true);
        }
    }
    //提交
    function SubmitAuditCase() {
        //$("#shenpiyijian").find('[data-field="LoanDetailReportFile"]').removeAttr("data-field").removeAttr("data-class");
        //$("#shenpiyijian").find('[data-field="CaseDetail"]').removeAttr("data-field").removeAttr("data-class");
        if ($("#basecase_facility_list").find("tr").length > 1) {
            if (ValidateCheck(".page-content")) {
                var result = false;
                for (var i = 0; i < $('[data-field="CollateralTypeText"]').length; i++) {
                    if ($('[data-field="CollateralTypeText"]').eq(i).html() == "抵押物") {
                        result = true;
                        break;
                    }
                }
                if (!result) {
                    showAlert("房产信息-抵押物 不能为空", "error");
                    $('[href="#facility"]').click();
                    $("#fangchaninfo").click();
                } else {
                    ConfirmBox('<div>是否确认提交?</div><br><textarea rows="5" cols="38" width="100%" placeholder="备注" id="des"></textarea>', function () {
                        $('#BaseAudit_Description').val($("#des").val());
                        var data_case = GetJsonData("BaseAudit", $(window.document));
                        data_case = checkSelectNull(data_case);
                        selAccount();
                        AjaxMethod("post", "/Audit/SubmitBaseAudit", data_case, function (r) {
                            MessageBox("提交成功", function () {
                                window.close();
                            });
                            hideLoading();
                            //						showAlert("提交成功，3秒后自动关闭页面");
                            //						closeAll();
                        }, true);
                    });
                }
            }
        } else {
            showAlert("房产信息-抵押物 不能为空", "error");
            $('[href="#facility"]').click();
            $("#fangchaninfo").click();
        }
    }

    //通过
    function ApprovalAuditCase() {
        //$("#fengkongjindiao").find('[data-field="LoanDetailReportFile"]').removeAttr("data-field").removeAttr("data-class");
        //$("#fengkongjindiao").find('[data-field="CaseDetail"]').removeAttr("data-field").removeAttr("data-class");
        if ($("#basecase_facility_list").find("tr").length > 1) {
            if (ValidateCheck(".page-content")) {
                ConfirmBox('<div>是否确认通过?</div><br><textarea rows="5" cols="38" width="100%" placeholder="备注" id="des"></textarea>', function () {
                    $('#BaseAudit_Description').val($("#des").val());
                    var data_case = GetJsonData("BaseAudit", $(window.document));
                    data_case = checkSelectNull(data_case);
                    selAccount();
                    AjaxMethod("post", "/Audit/ApprovalBaseAudit", data_case, function (r) {
                        MessageBox("审批通过", function () {
                            window.close();
                        });
                        hideLoading();
                        //					showAlert("审批通过，3秒后自动关闭页面");
                        //					closeAll();
                    }, true);
                });
            }
        } else {
            showAlert("房产信息-抵押物 不能为空", "error");
            $('[href="#facility"]').click();
            $("#fangchaninfo").click();
        }

    }

    //退回
    function RollbackAuditCase() {
        if (ValidateCheck(".page-content")) {
            ConfirmBox("<div>是否确认退回?</div><br><textarea rows='5' cols='38' width='100%' placeholder='备注' id='des'></textarea>", function () {
                $('#BaseAudit_Description').val($("#des").val());
                var data_case = GetJsonData("BaseAudit", $(window.document));
                data_case = checkSelectNull(data_case);
                selAccount();
                AjaxMethod("post", "/Audit/ReturnBaseAudit", data_case, function (r) {
                    MessageBox("审批退回", function () {
                        window.close();
                    });
                    hideLoading();
                    //				showAlert("审批退回，3秒后自动关闭页面", "error");
                    //				closeAll();
                    //                  window.location = "/Audit/AuditIndex?status=rb";
                }, true);
            });
        }
    }

    //拒绝
    function RejectAuditCase() {
        //  	OpenDialog("reject_block", function () {
        //  		var data_case = GetJsonData("BaseAudit", $(window.document));
        //  		ConfirmBox("<input type='text' placeholder='拒绝原因' id='yuanyin'/>",function(){
        //	    		AjaxMethod("post", "/Audit/RejectBaseAudit", data_case, function (r) {
        //		            window.location = "/Audit/AuditIndex?status=rj";
        //		        }, true);
        //	    	});
        //	    });
        rejectBlock();
    }

    function rejectBlock() {
        $("#reject_block").dialog({
            position: {
                my: "center",
                at: "center",
                of: window,
                collision: "fit",
                using: function (pos) {
                    var topOffset = $(this).css(pos).offset().top;
                    if (topOffset < 0) {
                        $(this).css("top", pos.top - topOffset);
                    } else {
                        $(this).css("top", "200px");
                    }
                }
            },
            modal: true,
            title: "<div class='widget-header'><h4 class='smaller'><i class='icon-warning-sign orange'></i>拒绝理由</h4></div>",
            title_html: true,
            beforeClose: function () {
                reset_form("reject_block");
            },
            buttons: [{
                html: "<i class='icon-ok bigger-110'></i>&nbsp; 确定",
                "class": "btn btn-primary btn-xs",
                click: function () {
                    $('#BaseAudit_Description').val($("#Description").val());
                    if ($("[name='RejectType']:checked").length == 0) {
                        showAlert("请选择拒绝理由", "error");
                        //$("#RejectReason").val("");
                        //$(this).dialog("close");
                    } else {
                        var reject_val = "";
                        $("[name='RejectType']:checked").each(function (index) {
                            if (index == 0) {
                                reject_val = $(this).val();
                            } else {
                                reject_val = reject_val + "," + $(this).val();
                            }
                        });
                        //	                		RejectType
                        $("#RejectType").val(reject_val);
                        //数据准备
                        var data_case = GetJsonData("BaseAudit", $(window.document));
                        selAccount();
                        AjaxMethod("post", "/Audit/RejectBaseAudit", data_case, function (r) {
                            MessageBox("审批拒绝", function () {
                                window.close();
                            });
                            hideLoading();
                            //						showAlert("审批拒绝，3秒后自动关闭页面", "error")
                            //						closeAll();
                            //					            window.location = "/Audit/AuditIndex?status=rj";
                        }, true);
                        $(this).dialog("close");

                    }
                }
            }, {
                html: "<i class='icon-remove bigger-110'></i>&nbsp; 取消",
                "class": "btn btn-xs",
                click: function () {
                    $(this).dialog("close");
                }
            }]
        }).removeClass('hide');
    }
    //页面初始化
    jQuery(function ($) {
        //加载页面数据
        LoadPageData();
        rate();
        var date = new Date();
        var htm = "";
        for (var i = date.getFullYear() - 70; i < date.getFullYear() + 70; i++) {
            htm = htm + "<option ='" + i + "'>" + i + "</option>";
        }
        $('[data-field="CompletionDate"]').append(htm);
        dictionaryHide();
    });

    function changeHouse(obj) {
        var tr = $("#basecase_facility_list").find("tbody").find("tr");
        var arr = [];
        for (var i = 0; i < tr.length; i++) {
            if (tr.eq(i).find('[data-field="ID"]').html() == obj.value) {
                $("#houseId").val(tr.eq(i).find('[data-field="HouseNumber"]').html());
                $("#dialog_HouseDetails").find('[data-field="BuildingName"]').val(tr.eq(i).find('[data-field="BuildingName"]').html());
                $("#dialog_HouseDetails").find('[data-field="Address"]').val(tr.eq(i).find('[data-field="Address"]').html());
                $("#dialog_HouseDetails").find('[data-field="HouseSize"]').val(tr.eq(i).find('[data-field="HouseSize"]').html());
                $("#dialog_HouseDetails").find('[data-field="CompletionDate"]').val(tr.eq(i).find('[data-field="CompletionDate"]').html());
                $("#dialog_HouseDetails").find('[data-field="HouseType"]').val(tr.eq(i).find('[data-field="HouseType"]').html());
                $("#dialog_HouseDetails").find('[data-field="LandType"]').val(tr.eq(i).find('[data-field="LandType"]').html());
            }
        }
        if (obj.value == "") {
            $("#houseId").val("");
            $("#dialog_HouseDetails").find('[data-field="BuildingName"]').val("");
            $("#dialog_HouseDetails").find('[data-field="Address"]').val("");
            $("#dialog_HouseDetails").find('[data-field="HouseSize"]').val("");
            $("#dialog_HouseDetails").find('[data-field="CompletionDate"]').val("");
            $("#dialog_HouseDetails").find('[data-field="HouseType"]').val("");
            $("#dialog_HouseDetails").find('[data-field="LandType"]').val("");
        }
    }
    //加载页面数据
    var LoadPageData = function () {
        var bc_id = $("#BaseAudit_ID").val();
        showLoading();
        AjaxMethod("get", "/Audit/GetBaseAudit", {
            id: bc_id
        }, function (r) {
            if (r.Data.AuditHistory) {
                var str = '<div class="timeline-label">' +
                    '<span class="label label-primary arrowed-in-right label-lg">' +
                    '<b>当前节点</b>' +
                    '</span>' +
                    '</div>';
                var hisArr = r.Data.AuditHistory;
                for (var i = 0; i < hisArr.length; i++) {
                    var color = "red";
                    if (hisArr[i].Action == "提交" || hisArr[i].Action == "通过") {
                        color = "green";
                    }
                    var Description = "";
                    var flag = "";
                    if (hisArr[i].Description != null && hisArr[i].Description != "") {
                        Description = '<div class="widget-body">' +
                            '<div class="widget-main ' + color + '">' +
                            '备注：<br>' +
                            '<span class="' + color + '">' + hisArr[i].Description + '</span>' +
                            '<div class="space-6"></div>' +
                            '</div>' +
                            '</div>';
                        flag = '<span class="widget-toolbar">' +
                            '<a href="#" data-action="collapse">' +
                            '<i class="icon-chevron-up"></i>' +
                            '</a>' +
                            '</span>';
                    }
                    var user = "";
                    if (i != 0) {
                        user = hisArr[i].CreatUser;
                    }
                    var date_time = "";
                    if (dateFormat(hisArr[i].CreateTime) != "") {
                        date_time = '<i class="icon-time bigger-110"></i>' + dateFormat(hisArr[i].CreateTime);
                    }
                    str = str + '<div class="timeline-item clearfix">' +
                        '<div class="timeline-info">' +
                        '<i class="timeline-indicator icon-star btn btn-warning no-hover green"></i>' +
                        '</div>' +
                        '<div class="widget-box transparent">' +
                        '<div class="widget-header widget-header-small">' +
                        '<h5 class="smaller">' +
                        '<a class="blue">' + hisArr[i].CaseStatusTest + '</a>&nbsp;&nbsp;' +
                        '<span class="grey">' + user + '</span>&nbsp;&nbsp;' +
                        '<span class="' + color + '">' + hisArr[i].Action + '</span>' +
                        '</h5>' +
                        '<span class="widget-toolbar no-border">' +
                        date_time +
                        '</span>' +
                        flag +
                        '</div>' +
                        Description +
                        '</div>' +
                        '</div>';
                }
                $("#historyContent").html(str);
            }
            GetDistrict(false, function () {
                $("#basic [data-class='BaseAudit'][data-field='DistrictID']").val(r["Data"]["DistrictID"]);
                districtChange(false, function () {
                    $("#basic [data-class='BaseAudit'][data-field='SalesGroupID']").val(r["Data"]["SalesGroupID"]);
                    salesGroupChange(false, function () {
                        GetDictionary($("#borrower_idtype"), "-DocType", function () {
                            SetJsonData(r["Data"], "BaseAudit");
//                          readonly();
//                          if ($("#auditStatus").val() == "2") {
//                              $("#shenpiyijian").find(".form-control,.new_add,.green,.red,.file_btn>.btn,.fileupload,.ui-button-text,.date-picker").removeAttr("disabled");
//                          }
//                          if ($('[data-field="CaseMode"]').val() == "-CaseMode-ZiYouZiJin") {
//                              $('[data-field="ThirdParty"]').val("").attr("disabled", true);
//                          }
//                          if ($("#CaseStatusRW").val() != "edit") {
//                              $("[type=radio]").attr("disabled", true);
//                          }
//                          $('[data-field="MaritalStatus"]').each(function () {
//                              if ($(this).val() == "-MaritalStatus-Unmarried" || $(this).val() == "") {//不未婚的情况下
//                                  $(this).parent().parent().find('[data-field="MarryFile"]').removeAttr("required").siblings().eq(0).html("婚姻证明");
//                              } else {
//                                  $(this).parent().parent().find('[data-field="MarryFile"]').attr("required", true).siblings().eq(0).html("婚姻证明 <span class='red'>*</span>");
//                              }
//                          });
//                          $('[data-field="CaseMode"]').attr("disabled",true);
//                          $('[data-field="ThirdParty"]').attr("disabled", true);
//                          $('[data-field="ThirdPartyAuditAmount"]').attr("disabled", true);
//                          $('[data-field="ThirdPartyAuditTerm"]').attr("disabled", true);
//                          $('[data-field="ThirdPartyAuditRate"]').attr("disabled", true);
                            $("tbody").children("tr").each(function (index) {
                                if (index != 0) {
                                    $(this).prepend($(this).children('[data-field="ID"]').clone());
                                    $(this).children('[data-field="ID"]').eq(1).remove();
                                }
                            });
                            selAccount();
                            hideLoading();
                        });
                    });
                });
            });
        }, false);
    };
    var limitDate = "";
    function longterm(obj) {
        var objuse = $(obj).parent().siblings('[data-field="ExpiryDate"]');
        limitDate = objuse.val();
        if (obj.checked) {
            $(obj).parent().siblings('[data-field="ExpiryDate"]').attr("disabled", true);
            $(obj).parent().siblings('[data-field="ExpiryDate"]').val("9999-12-31");
        } else {
            $(obj).parent().siblings('[data-field="ExpiryDate"]').attr("disabled", false);
            $(obj).parent().siblings('[data-field="ExpiryDate"]').val(limitDate);
        }
    };
</script>

<style>
    .timeline-container:not(.timeline-style2) .timeline-indicator {
        opacity: 1;
        border-radius: 100%;
        display: inline-block;
        font-size: 16px;
        height: 36px;
        line-height: 30px;
        width: 36px;
        text-align: center;
        text-shadow: none !important;
        padding: 0;
        cursor: default;
        border: 3px solid #FFF !important;
    }

    #reject_block {
        overflow: hidden;
        display: block;
        margin: 0 auto;
    }
</style>                    